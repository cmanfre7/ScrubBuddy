generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Settings
  step2Date     DateTime?
  comlexDate    DateTime?
  dailyGoal     Int       @default(40)
  weeklyGoal    Int       @default(200)

  // Relations
  rotations     Rotation[]
  patients      Patient[]
  procedures    UserProcedure[]
  uworldLogs    UWorldLog[]
  uworldQuestions UWorldQuestion[]
  uworldTests   UWorldTest[]
  uworldIncorrects UWorldIncorrect[]
  shelfScores   ShelfScore[]
  practiceExams PracticeExam[]
  tasks         Task[]
  studyBlocks   StudyBlock[]
  resources     Resource[]
  aiConversations AIConversation[]
  studyNotes    StudyNote[]
  clinicalGuidelines ClinicalGuideline[]
  ankiProgress  AnkiProgress[]
  ankiGoal      AnkiGoal?
  ankiSyncToken AnkiSyncToken?
  ankiSyncStats AnkiSyncStats[]
  ankiDeckStats AnkiDeckStats[]
  clinicalPearls ClinicalPearl[]
  clinicalReferences ClinicalReference[]
  pharmNotes    PharmNote[]
  boardExams    BoardExam[]
  calendarEvents CalendarEvent[]
  googleCalendarSync GoogleCalendarSync?
  uworldSettings UWorldSettings[]
  quickLinks    QuickLink[]
  calendarFeed  CalendarFeed?
  clinicalAlgorithms ClinicalAlgorithm[]
}

// ==================== ROTATIONS ====================

model Rotation {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String    // "Psychiatry", "Pediatrics", etc.
  startDate   DateTime
  endDate     DateTime
  shelfDate   DateTime?
  shelfTarget Int?      // Target score for shelf exam (e.g., 75)
  isCurrent   Boolean   @default(false)

  // Relations
  patients    Patient[]
  shelfScores ShelfScore[]
  studyNotes  StudyNote[]
  clinicalGuidelines ClinicalGuideline[]
  clinicalPearls ClinicalPearl[]
  clinicalReferences ClinicalReference[]
  pharmNotes  PharmNote[]
  clinicalAlgorithms ClinicalAlgorithm[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

// ==================== PATIENTS ====================

model Patient {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId      String?
  rotation        Rotation? @relation(fields: [rotationId], references: [id])

  // Required
  chiefComplaint  String
  diagnosis       String
  encounterDate   DateTime  @default(now())

  // Optional
  secondaryDx     String[]  @default([])
  setting         String?   // "Inpatient", "Outpatient", "ED", "OR", etc.
  ageGroup        String?   // "Neonate", "Pediatric", "Adult", "Geriatric"
  attendingName   String?
  learningPoints  String?   @db.Text
  followUpNeeded  Boolean   @default(false)
  followUpNotes   String?

  // Relations
  proceduresPerformed  PatientProcedure[] @relation("performed")
  proceduresObserved   PatientProcedure[] @relation("observed")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
}

model PatientProcedure {
  id            String    @id @default(cuid())
  patientId     String
  procedureId   String
  type          String    // "performed" or "observed"

  patientPerformed  Patient?  @relation("performed", fields: [patientId], references: [id], onDelete: Cascade, map: "fk_performed")
  patientObserved   Patient?  @relation("observed", fields: [patientId], references: [id], onDelete: Cascade, map: "fk_observed")
  procedure         Procedure @relation(fields: [procedureId], references: [id])

  @@index([patientId])
  @@index([procedureId])
}

// ==================== PROCEDURES ====================

model Procedure {
  id                String    @id @default(cuid())

  // Core info
  name              String
  category          String    // "General", "Advanced", "Specialty"
  specialty         String    // "Surgery", "Medicine", "OB", etc.

  // Content
  indications       String[]  @default([])
  contraindications String[]  @default([])
  supplies          String[]  @default([])
  steps             Json      // Array of step objects
  pearls            String[]  @default([])
  commonMistakes    String[]  @default([])
  documentationTpl  String?   @db.Text

  // Metadata
  estimatedTime     String?
  difficulty        Int       @default(1) // 1-5
  videoUrl          String?

  // Is this a default procedure or user-created?
  isDefault         Boolean   @default(false)
  createdByUserId   String?

  // Relations
  userProcedures    UserProcedure[]
  patientProcedures PatientProcedure[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model UserProcedure {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  procedureId     String
  procedure       Procedure @relation(fields: [procedureId], references: [id])

  // User-specific tracking
  timesPerformed  Int       @default(0)
  timesObserved   Int       @default(0)
  lastPerformed   DateTime?
  confidenceLevel Int       @default(1) // 1-5
  personalNotes   String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, procedureId])
  @@index([userId])
}

// ==================== UWORLD ====================

// User-specific UWorld question bank totals per subject
model UWorldSettings {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  subject       String    // "OBGYN", "Surgery", etc.
  totalQuestions Int      // Custom total for this subject

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, subject])
  @@index([userId])
}

model UWorldLog {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  date          DateTime  @default(now())
  questionsTotal Int
  questionsCorrect Int
  timeSpentMins Int?
  mode          String?   // "timed", "tutor", "review"
  blockName     String?

  // Topic tracking
  systems       String[]  @default([]) // ["Cardio", "Pulm"]
  subjects      String[]  @default([]) // ["Pathology", "Pharm"]

  notes         String?

  // Relations
  questions     UWorldQuestion[]

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([date])
}

// Individual questions linked to a session (both correct and incorrect)
model UWorldQuestion {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  logId         String?   // Link to UWorldLog session
  log           UWorldLog? @relation(fields: [logId], references: [id], onDelete: Cascade)

  questionId    String?   // UWorld question ID (e.g., "104520")
  subject       String    // Subject (e.g., "Surgery", "Medicine")
  system        String    // System (e.g., "Hematology & Oncology")
  category      String    // Category
  topic         String    // Topic
  percentOthers Int       @default(0)  // % of others who got it correct
  timeSpent     Int       @default(0)  // Time spent in seconds
  isCorrect     Boolean   // Whether user got this question correct
  testName      String?   // Test name for reference

  createdAt     DateTime  @default(now())

  @@unique([userId, questionId])
  @@index([userId])
  @@index([logId])
  @@index([subject])
  @@index([system])
  @@index([isCorrect])
}

// Individual UWorld Test with detailed subject breakdown
model UWorldTest {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  testName        String    // "16 - Week 1 - OBGYN"
  testId          String?   // Optional UWorld test ID
  date            DateTime  @default(now())

  // Overall stats
  totalCorrect    Int
  totalIncorrect  Int
  totalOmitted    Int       @default(0)
  percentCorrect  Int       // Calculated percentage

  // Test metadata
  mode            String?   // "timed", "tutor", "review"
  timeSpentMins   Int?
  notes           String?   @db.Text

  // Relations
  subjects        UWorldTestSubject[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([date])
}

// Subject/System performance breakdown for each test
model UWorldTestSubject {
  id            String    @id @default(cuid())
  testId        String
  test          UWorldTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  subjectName   String    // "Pregnancy, Childbirth & Puerperium", "Female Reproductive System & Breast", etc.
  category      String    // "Medicine", "OBGYN", "Surgery", etc. - the top-level category

  totalQuestions  Int
  correct         Int
  incorrect       Int
  omitted         Int     @default(0)
  percentCorrect  Int     // Calculated percentage

  createdAt     DateTime  @default(now())

  @@index([testId])
  @@index([subjectName])
}

model UWorldIncorrect {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  questionId    String?   // Optional UWorld question ID (e.g., "104520")
  topic         String    // Topic from PDF (e.g., "Hypovolemic shock")
  concept       String?   // Optional additional concept
  whyWrong      String?   // "Misread", "Didn't Know", "Second-guessed", "Silly Mistake"
  learningPoint String?   @db.Text

  // New fields from PDF import
  subject       String?   // Subject (e.g., "Surgery", "Medicine")
  system        String?   // System (e.g., "Hematology & Oncology", "Pulmonary & Critical Care")
  category      String?   // Category (e.g., "Hemostasis and thrombosis", "Critical care and trauma medicine")
  percentOthers Int?      // % of others who got it correct
  timeSpent     Int?      // Time spent in seconds
  testName      String?   // Test name for grouping (e.g., "18 - Surgery")

  status        String    @default("needs_review") // "needs_review", "reviewed", "mastered"
  reviewCount   Int       @default(0)
  nextReviewAt  DateTime?
  lastReviewedAt DateTime?

  // Link to patient if relevant
  patientId     String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, questionId]) // Prevent duplicate questions per user
  @@index([userId])
  @@index([status])
  @@index([subject])
  @@index([system])
}

model ShelfScore {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  rotationName String   // Denormalized for easy access
  score       Int
  percentile  Int?
  goalScore   Int?
  date        DateTime
  notes       String?

  createdAt   DateTime  @default(now())

  @@index([userId])
}

model PracticeExam {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  examType      String    // "NBME", "UWSA", "COMSAE", "FREE120"
  examName      String    // "NBME 9", "UWSA1", "UWSA2", "COMSAE 105"
  score         Int
  predictedScore Int?
  percentCorrect Float?
  date          DateTime
  weakAreas     String[]  @default([])
  notes         String?   @db.Text
  actionItems   String?   @db.Text

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([examType])
}

// ==================== TASKS ====================

model Task {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  text        String
  done        Boolean   @default(false)
  dueDate     DateTime?
  priority    Int       @default(0) // Higher = more important
  recurring   String?   // "daily", "weekdays", "weekly", null
  category    String?   // "study", "clinical", "personal"

  // For recurring tasks, track completions per day
  completions TaskCompletion[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([done])
  @@index([recurring])
}

// Track per-day completions for recurring tasks
model TaskCompletion {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  date      DateTime // The date this completion is for (stored as date, time ignored)
  completed Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([taskId, date])
  @@index([taskId])
  @@index([date])
}

// ==================== STUDY PLANNER ====================

model StudyBlock {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  type        String    // "uworld", "anki", "review", "video", "reading"
  topic       String?
  startTime   DateTime
  endTime     DateTime
  recurring   String?   // "daily", "weekdays", etc.
  completed   Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([startTime])
}

// ==================== RESOURCES ====================

model Resource {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Core info
  name        String
  description String?   @db.Text
  url         String?   // External URL (website, video link, podcast link)

  // Type: video, podcast, website, pdf, document, qbank, anki
  type        String

  // For organization
  subject     String?   // "Surgery", "Internal Medicine", "OBGYN", etc.
  rotation    String?   // Link to specific rotation name
  tags        String[]  @default([])

  // For videos/podcasts
  embedUrl    String?   // Embedded player URL (YouTube embed, Spotify embed, etc.)
  duration    String?   // "45:30" or "1h 23m"
  channel     String?   // YouTube channel, Podcast name (Divine Intervention, etc.)
  thumbnail   String?   // Thumbnail URL

  // For PDFs/Documents
  fileUrl     String?   // URL to PDF/document file (S3, Cloudinary, etc.)
  fileName    String?   // Original filename
  fileSize    Int?      // Size in bytes
  pageCount   Int?      // For PDFs

  // For websites
  favicon     String?   // Website favicon URL

  // Metadata
  isFavorite  Boolean   @default(false)
  isArchived  Boolean   @default(false)
  viewCount   Int       @default(0)
  lastAccessed DateTime?
  notes       String?   @db.Text  // Personal notes about the resource

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([type])
  @@index([subject])
}

// ==================== AI ====================

model AIConversation {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages    Json      // Array of {role, content, timestamp}
  summary     String?   // AI-generated summary of conversation

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

// ==================== STUDY NOTES ====================

model StudyNote {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  title       String
  content     String    @db.Text
  category    String    // "high_yield", "diagnosis", "preceptor_tip", "clinical_pearl", "other"
  tags        String[]  @default([])
  source      String?   // "preceptor", "uworld", "lecture", "reading", "patient"
  isStarred   Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([category])
}

// ==================== CLINICAL GUIDELINES ====================

model ClinicalGuideline {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  title       String    // "Breast Mass Workup"
  description String?
  specialty   String    // "OBGYN", "Surgery", "Medicine", etc.
  content     Json      // Structured decision tree or algorithm
  source      String?   // "UpToDate", "ACOG", "ACS", etc.
  lastReviewed DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([specialty])
}

// ==================== ANKI TRACKING ====================

model AnkiProgress {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  date        DateTime  @default(now())
  newCards    Int       @default(0)
  reviewCards Int       @default(0)
  totalTime   Int?      // minutes
  deckName    String?   // "AnKing", "Zanki", etc.

  createdAt   DateTime  @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model AnkiGoal {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalCards      Int       @default(0)     // Total cards in deck
  cardsCompleted  Int       @default(0)     // Cards already mature/learned
  targetDate      DateTime?                  // Goal completion date (e.g., Step 2 date)
  dailyNewGoal    Int       @default(30)    // Target new cards per day
  dailyReviewGoal Int       @default(200)   // Target reviews per day

  updatedAt       DateTime  @updatedAt
}

// API token for AnkiConnect sync authentication
model AnkiSyncToken {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  token       String    @unique // Hashed API token
  lastSyncAt  DateTime?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Detailed stats from AnkiConnect sync
model AnkiSyncStats {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  syncedAt        DateTime  @default(now())

  // Cards due today (from all decks)
  newDue          Int       @default(0)     // New cards due today
  reviewDue       Int       @default(0)     // Review cards due today
  learningDue     Int       @default(0)     // Learning cards due today
  totalDue        Int       @default(0)     // Total cards due

  // Today's stats (what user has done)
  newStudied      Int       @default(0)     // New cards studied today
  reviewsStudied  Int       @default(0)     // Reviews completed today
  learnedToday    Int       @default(0)     // Cards learned today
  timeStudiedSecs Int       @default(0)     // Time spent today (seconds)

  // Answer breakdown
  againCount      Int       @default(0)     // Times 'Again' was pressed
  hardCount       Int       @default(0)     // Times 'Hard' was pressed
  goodCount       Int       @default(0)     // Times 'Good' was pressed
  easyCount       Int       @default(0)     // Times 'Easy' was pressed

  // Overall collection stats
  totalCards      Int       @default(0)     // Total cards in collection
  totalNotes      Int       @default(0)     // Total notes
  matureCards     Int       @default(0)     // Cards with interval >= 21 days
  youngCards      Int       @default(0)     // Cards with interval < 21 days
  suspendedCards  Int       @default(0)     // Suspended cards
  buriedCards     Int       @default(0)     // Buried cards

  // Retention/performance
  retentionRate   Float?    // Calculated retention rate

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([syncedAt])
}

// Per-deck stats from AnkiConnect
model AnkiDeckStats {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  deckName        String
  deckId          String?   // Anki's internal deck ID

  // Cards due
  newDue          Int       @default(0)
  reviewDue       Int       @default(0)
  learningDue     Int       @default(0)

  // Total counts
  totalCards      Int       @default(0)
  totalNew        Int       @default(0)
  totalLearning   Int       @default(0)
  totalReview     Int       @default(0)
  totalSuspended  Int       @default(0)

  syncedAt        DateTime  @default(now())

  @@unique([userId, deckName])
  @@index([userId])
}

// ==================== CLINICAL PEARLS ====================

model ClinicalPearl {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  // Flashcard content
  content     String    @db.Text  // Front of flashcard (question/prompt)
  backContent String?   @db.Text  // Back of flashcard (answer/explanation)

  // Optional image attachment (paste into front or back textarea)
  imageData      String?   @db.Text  // Base64 encoded image
  imageType      String?   // MIME type: "image/png", "image/jpeg", etc.
  imagePlacement String?   // "front" or "back" - which side of flashcard

  tags        String[]  @default([])
  isHighYield Boolean   @default(false) // Marked for shelf exam review
  source      String?   // "rounds", "attending", "patient", "reading", "other"

  // Optional link to patient encounter
  patientId   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([isHighYield])
}

// ==================== CLINICAL REFERENCES ====================

model ClinicalReference {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  title       String
  category    String    // "guideline", "scale", "algorithm", "custom"
  content     String    @db.Text
  url         String?   // Optional external link
  source      String?   // "UpToDate", "MDCalc", "Custom", etc.

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([category])
}

// ==================== PHARMACOLOGY ====================

model PharmNote {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  drugName    String
  drugClass   String?   // "SSRI", "Beta Blocker", "Antibiotic", etc.
  indication  String?
  mechanism   String?   @db.Text
  sideEffects String?   @db.Text
  warnings    String?   @db.Text
  pearls      String?   @db.Text // High-yield clinical pearls

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([drugClass])
}

// ==================== BOARD EXAMS ====================

model BoardExam {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  examType        String    // "USMLE_STEP_2_CK", "COMLEX_LEVEL_2_CE"
  targetScore     Int       // User's target score
  predictedScore  Int?      // Calculated predicted score
  examDate        DateTime? // Scheduled exam date

  // Readiness metrics
  readinessPercent Int?     // 0-100 readiness score
  daysUntilExam   Int?      // Calculated field

  // For calculations
  lastUpdated     DateTime  @default(now())

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, examType])
  @@index([userId])
}

// ==================== CALENDAR ====================

model CalendarEvent {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Event details
  title           String
  description     String?   @db.Text
  location        String?

  // Timing
  startTime       DateTime
  endTime         DateTime
  isAllDay        Boolean   @default(false)
  timeZone        String    @default("America/New_York")

  // Categorization
  eventType       String    // "clinical", "exam", "study", "lecture", "presentation", "personal", "meeting", "appointment"
  category        String?   // Optional subcategory
  color           String?   // Hex color for display

  // Recurrence
  isRecurring     Boolean   @default(false)
  recurrenceRule  String?   // RRULE format (e.g., "FREQ=WEEKLY;BYDAY=MO,WE,FR")
  recurrenceEnd   DateTime?
  parentEventId   String?   // For recurring event instances

  // Reminders
  reminderMins    Int[]     @default([]) // e.g., [15, 60] for 15min and 1hr before

  // External sync
  googleEventId   String?   @unique
  googleCalendarId String?  // Which Google Calendar this came from
  isSynced        Boolean   @default(false)
  lastSyncedAt    DateTime?

  // Links to other entities
  rotationId      String?
  taskId          String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([startTime])
  @@index([eventType])
  @@index([googleEventId])
}

model GoogleCalendarSync {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // OAuth tokens
  accessToken       String    @db.Text
  refreshToken      String    @db.Text
  tokenExpiresAt    DateTime

  // Google user info
  googleEmail       String?

  // Sync settings
  syncEnabled       Boolean   @default(true)
  selectedCalendars String[]  @default([]) // Google Calendar IDs to sync
  lastSyncAt        DateTime?
  syncDirection     String    @default("both") // "both", "to_google", "from_google"
  syncToken         String?   @db.Text // For incremental sync

  // Conflict resolution
  preferLocal       Boolean   @default(false) // On conflict, prefer local or Google changes

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
}

// ==================== QUICK LINKS ====================

model QuickLink {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  url         String
  order       Int       @default(0) // For sorting

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

// ==================== CALENDAR FEED (ICS) ====================

model CalendarFeed {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  token       String    @unique  // Secure random token for feed URL
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([token])
}

// ==================== CLINICAL ALGORITHMS ====================

model ClinicalAlgorithm {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  title       String    // "Blunt Chest Trauma", "Breast Mass Workup", etc.
  description String?   @db.Text // Optional notes about the algorithm
  subject     String    // "Surgery", "OBGYN", "Internal Medicine", etc. (shelf subject)

  // Content - either image OR text (at least one required)
  imageData   String?   @db.Text // Base64 encoded image data (optional if textContent provided)
  imageType   String?   // MIME type: "image/png", "image/jpeg", etc.
  textContent String?   @db.Text // Text-based algorithm content (markdown supported)

  // Metadata
  source      String?   // "UWorld", "UpToDate", "First Aid", etc.
  tags        String[]  @default([])
  isHighYield Boolean   @default(false) // Mark important ones for quick review

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([subject])
  @@index([isHighYield])
}
