generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Settings
  step2Date     DateTime?
  comlexDate    DateTime?
  dailyGoal     Int       @default(40)
  weeklyGoal    Int       @default(200)

  // Relations
  rotations     Rotation[]
  patients      Patient[]
  procedures    UserProcedure[]
  uworldLogs    UWorldLog[]
  uworldIncorrects UWorldIncorrect[]
  shelfScores   ShelfScore[]
  practiceExams PracticeExam[]
  tasks         Task[]
  studyBlocks   StudyBlock[]
  resources     Resource[]
  aiConversations AIConversation[]
  studyNotes    StudyNote[]
  clinicalGuidelines ClinicalGuideline[]
  ankiProgress  AnkiProgress[]
  ankiGoal      AnkiGoal?
  clinicalPearls ClinicalPearl[]
  clinicalReferences ClinicalReference[]
  pharmNotes    PharmNote[]
  boardExams    BoardExam[]
  calendarEvents CalendarEvent[]
  googleCalendarSync GoogleCalendarSync?
}

// ==================== ROTATIONS ====================

model Rotation {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String    // "Psychiatry", "Pediatrics", etc.
  startDate   DateTime
  endDate     DateTime
  shelfDate   DateTime?
  shelfTarget Int?      // Target score for shelf exam (e.g., 75)
  isCurrent   Boolean   @default(false)

  // Relations
  patients    Patient[]
  shelfScores ShelfScore[]
  studyNotes  StudyNote[]
  clinicalGuidelines ClinicalGuideline[]
  clinicalPearls ClinicalPearl[]
  clinicalReferences ClinicalReference[]
  pharmNotes  PharmNote[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

// ==================== PATIENTS ====================

model Patient {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId      String?
  rotation        Rotation? @relation(fields: [rotationId], references: [id])

  // Required
  chiefComplaint  String
  diagnosis       String
  encounterDate   DateTime  @default(now())

  // Optional
  secondaryDx     String[]  @default([])
  setting         String?   // "Inpatient", "Outpatient", "ED", "OR", etc.
  ageGroup        String?   // "Neonate", "Pediatric", "Adult", "Geriatric"
  attendingName   String?
  learningPoints  String?   @db.Text
  followUpNeeded  Boolean   @default(false)
  followUpNotes   String?

  // Relations
  proceduresPerformed  PatientProcedure[] @relation("performed")
  proceduresObserved   PatientProcedure[] @relation("observed")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
}

model PatientProcedure {
  id            String    @id @default(cuid())
  patientId     String
  procedureId   String
  type          String    // "performed" or "observed"

  patientPerformed  Patient?  @relation("performed", fields: [patientId], references: [id], onDelete: Cascade, map: "fk_performed")
  patientObserved   Patient?  @relation("observed", fields: [patientId], references: [id], onDelete: Cascade, map: "fk_observed")
  procedure         Procedure @relation(fields: [procedureId], references: [id])

  @@index([patientId])
  @@index([procedureId])
}

// ==================== PROCEDURES ====================

model Procedure {
  id                String    @id @default(cuid())

  // Core info
  name              String
  category          String    // "General", "Advanced", "Specialty"
  specialty         String    // "Surgery", "Medicine", "OB", etc.

  // Content
  indications       String[]  @default([])
  contraindications String[]  @default([])
  supplies          String[]  @default([])
  steps             Json      // Array of step objects
  pearls            String[]  @default([])
  commonMistakes    String[]  @default([])
  documentationTpl  String?   @db.Text

  // Metadata
  estimatedTime     String?
  difficulty        Int       @default(1) // 1-5
  videoUrl          String?

  // Is this a default procedure or user-created?
  isDefault         Boolean   @default(false)
  createdByUserId   String?

  // Relations
  userProcedures    UserProcedure[]
  patientProcedures PatientProcedure[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model UserProcedure {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  procedureId     String
  procedure       Procedure @relation(fields: [procedureId], references: [id])

  // User-specific tracking
  timesPerformed  Int       @default(0)
  timesObserved   Int       @default(0)
  lastPerformed   DateTime?
  confidenceLevel Int       @default(1) // 1-5
  personalNotes   String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, procedureId])
  @@index([userId])
}

// ==================== UWORLD ====================

model UWorldLog {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  date          DateTime  @default(now())
  questionsTotal Int
  questionsCorrect Int
  timeSpentMins Int?
  mode          String?   // "timed", "tutor", "review"
  blockName     String?

  // Topic tracking
  systems       String[]  @default([]) // ["Cardio", "Pulm"]
  subjects      String[]  @default([]) // ["Pathology", "Pharm"]

  notes         String?

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([date])
}

model UWorldIncorrect {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  questionId    String?   // Optional UWorld question ID
  topic         String
  concept       String?
  whyWrong      String?   // "Misread", "Didn't Know", "Second-guessed", "Silly Mistake"
  learningPoint String?   @db.Text

  status        String    @default("needs_review") // "needs_review", "reviewed", "mastered"
  reviewCount   Int       @default(0)
  nextReviewAt  DateTime?
  lastReviewedAt DateTime?

  // Link to patient if relevant
  patientId     String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

model ShelfScore {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  rotationName String   // Denormalized for easy access
  score       Int
  percentile  Int?
  goalScore   Int?
  date        DateTime
  notes       String?

  createdAt   DateTime  @default(now())

  @@index([userId])
}

model PracticeExam {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  examType      String    // "NBME", "UWSA", "COMSAE", "FREE120"
  examName      String    // "NBME 9", "UWSA1", "UWSA2", "COMSAE 105"
  score         Int
  predictedScore Int?
  percentCorrect Float?
  date          DateTime
  weakAreas     String[]  @default([])
  notes         String?   @db.Text
  actionItems   String?   @db.Text

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([examType])
}

// ==================== TASKS ====================

model Task {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  text        String
  done        Boolean   @default(false)
  dueDate     DateTime?
  priority    Int       @default(0) // Higher = more important
  recurring   String?   // "daily", "weekdays", "weekly", null
  category    String?   // "study", "clinical", "personal"

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([done])
}

// ==================== STUDY PLANNER ====================

model StudyBlock {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  type        String    // "uworld", "anki", "review", "video", "reading"
  topic       String?
  startTime   DateTime
  endTime     DateTime
  recurring   String?   // "daily", "weekdays", etc.
  completed   Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([startTime])
}

// ==================== RESOURCES ====================

model Resource {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  url         String
  category    String    // "qbank", "video", "anki", "guideline", "custom"
  rotation    String?   // Link to specific rotation
  tags        String[]  @default([])
  lastAccessed DateTime?

  createdAt   DateTime  @default(now())

  @@index([userId])
}

// ==================== AI ====================

model AIConversation {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages    Json      // Array of {role, content, timestamp}
  summary     String?   // AI-generated summary of conversation

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

// ==================== STUDY NOTES ====================

model StudyNote {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  title       String
  content     String    @db.Text
  category    String    // "high_yield", "diagnosis", "preceptor_tip", "clinical_pearl", "other"
  tags        String[]  @default([])
  source      String?   // "preceptor", "uworld", "lecture", "reading", "patient"
  isStarred   Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([category])
}

// ==================== CLINICAL GUIDELINES ====================

model ClinicalGuideline {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  title       String    // "Breast Mass Workup"
  description String?
  specialty   String    // "OBGYN", "Surgery", "Medicine", etc.
  content     Json      // Structured decision tree or algorithm
  source      String?   // "UpToDate", "ACOG", "ACS", etc.
  lastReviewed DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([specialty])
}

// ==================== ANKI TRACKING ====================

model AnkiProgress {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  date        DateTime  @default(now())
  newCards    Int       @default(0)
  reviewCards Int       @default(0)
  totalTime   Int?      // minutes
  deckName    String?   // "AnKing", "Zanki", etc.

  createdAt   DateTime  @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model AnkiGoal {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalCards      Int       @default(0)     // Total cards in deck
  cardsCompleted  Int       @default(0)     // Cards already mature/learned
  targetDate      DateTime?                  // Goal completion date (e.g., Step 2 date)
  dailyNewGoal    Int       @default(30)    // Target new cards per day
  dailyReviewGoal Int       @default(200)   // Target reviews per day

  updatedAt       DateTime  @updatedAt
}

// ==================== CLINICAL PEARLS ====================

model ClinicalPearl {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  content     String    @db.Text
  tags        String[]  @default([])
  isHighYield Boolean   @default(false) // Marked for shelf exam review
  source      String?   // "rounds", "attending", "patient", "reading", "other"

  // Optional link to patient encounter
  patientId   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([isHighYield])
}

// ==================== CLINICAL REFERENCES ====================

model ClinicalReference {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  title       String
  category    String    // "guideline", "scale", "algorithm", "custom"
  content     String    @db.Text
  url         String?   // Optional external link
  source      String?   // "UpToDate", "MDCalc", "Custom", etc.

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([category])
}

// ==================== PHARMACOLOGY ====================

model PharmNote {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rotationId  String?
  rotation    Rotation? @relation(fields: [rotationId], references: [id])

  drugName    String
  drugClass   String?   // "SSRI", "Beta Blocker", "Antibiotic", etc.
  indication  String?
  mechanism   String?   @db.Text
  sideEffects String?   @db.Text
  warnings    String?   @db.Text
  pearls      String?   @db.Text // High-yield clinical pearls

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([rotationId])
  @@index([drugClass])
}

// ==================== BOARD EXAMS ====================

model BoardExam {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  examType        String    // "USMLE_STEP_2_CK", "COMLEX_LEVEL_2_CE"
  targetScore     Int       // User's target score
  predictedScore  Int?      // Calculated predicted score
  examDate        DateTime? // Scheduled exam date

  // Readiness metrics
  readinessPercent Int?     // 0-100 readiness score
  daysUntilExam   Int?      // Calculated field

  // For calculations
  lastUpdated     DateTime  @default(now())

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, examType])
  @@index([userId])
}

// ==================== CALENDAR ====================

model CalendarEvent {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Event details
  title           String
  description     String?   @db.Text
  location        String?

  // Timing
  startTime       DateTime
  endTime         DateTime
  isAllDay        Boolean   @default(false)
  timeZone        String    @default("America/New_York")

  // Categorization
  eventType       String    // "clinical", "exam", "study", "lecture", "presentation", "personal", "meeting", "appointment"
  category        String?   // Optional subcategory
  color           String?   // Hex color for display

  // Recurrence
  isRecurring     Boolean   @default(false)
  recurrenceRule  String?   // RRULE format (e.g., "FREQ=WEEKLY;BYDAY=MO,WE,FR")
  recurrenceEnd   DateTime?
  parentEventId   String?   // For recurring event instances

  // Reminders
  reminderMins    Int[]     @default([]) // e.g., [15, 60] for 15min and 1hr before

  // External sync
  googleEventId   String?   @unique
  googleCalendarId String?  // Which Google Calendar this came from
  isSynced        Boolean   @default(false)
  lastSyncedAt    DateTime?

  // Links to other entities
  rotationId      String?
  taskId          String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([startTime])
  @@index([eventType])
  @@index([googleEventId])
}

model GoogleCalendarSync {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // OAuth tokens
  accessToken       String    @db.Text
  refreshToken      String    @db.Text
  tokenExpiresAt    DateTime

  // Sync settings
  syncEnabled       Boolean   @default(true)
  selectedCalendars String[]  @default([]) // Google Calendar IDs to sync
  lastSyncAt        DateTime?
  syncDirection     String    @default("both") // "both", "to_google", "from_google"

  // Conflict resolution
  preferLocal       Boolean   @default(false) // On conflict, prefer local or Google changes

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
}
